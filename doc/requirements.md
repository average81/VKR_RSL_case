# Требования и уточнение задачи

## Уточненные задачи

1. Провести предварительную обработку изображений: уменьшить размер до предельно допустимого, преобразовать к одной форме
хранения данных (число цветовых каналов), провести выравнивание страниц в равного размера прямоугольники, подобрав
матрицу трансформации. Нормализовать изображения по яркости (minmax нормализация), выровнять цветность (приведение к серому миру).
2. Кластеризовать по степени сходства изображения страниц, упорядоченных по идентификаторам. 
Для сравнения изображений использовать вектора признаков, полученные с помощью 
предобученной нейронной сети для работы с изображениями (Для базового варианта использовать алгоритм SIFT). В качестве критерия сходства использовать одну из мер
расстояние между векторами признаков. Условие запуска процесса объединения в кластер: расстояние между
векторами признаков 2 изображений, с подряд идущими идентификаторами, менее порога инициализации кластера дубликатов.
Условие финализации кластера дубликатов: расстояние между векторами признаков 2 изображений, с подряд
идущими идентификаторами, более порога финализации кластера дубликатов. Пороги инициализации и финализации кластеров
дубликатов, а также меру расстояния подобрать на обучающей выборке датасета по минимизации случаев ложного обнаружения дубликатов при максимизации 
полноты. Использовать кросс-валидацию для оценки выбора порогов. Рассчитать статистические параметры качества изображений, попавших в один кластер дубликатов: равномерность
гистограммы яркости, подсчет количества оттенков яркости, дисперсию оттенков относительно среднего значения. Оставить
изображение, имеющее более равномерную гистограмму оттенков, наибольшее количество оттенков яркости, наибольшую
дисперсию яркости относительно среднего значения. Выбор осуществлять мажоритарным голосованием по трем перечисленным критериям.
При наличии нескольких дубликатов с одинаковым числом баллов мажоритарного голосования выбирать изображения в следующем 
порядке по убыванию важности критериев: наибольшее число оттенков яркости, наибольшая дисперсия яркости, наиболее ровная
гистограмма оттенков яркости.
3. Выполнить сравнение всех изображений страниц последовательно по упорядоченным идентификаторам с изображениями
заголовков и логотипов, располагаемых на титульных страницах. Использовать механизм, описанный в п.1. 
При расстоянии между признаками изображения логотипа и признаками изображения страницы менее заданного порога провести
регистрацию логотипа на изображении страницы, после чего обрезать изображение страницы по регистрированному логотипу (если
матрица трансформации дает угол поворота не более 5 градусов) и провести расчет расстояния между признаками логотипа и 
обрезанного изображения страницы. Условие запуска процесса объединения в кластер/финализации предыдущего кластера по 
выпуску номера: расстояние между признаками изображений менее заданного порога. Порог инициализации и финализации кластеров
выпусков, а также меру расстояния подобрать на обучающей выборке датасета по минимизации случаев ложного обнаружения титульных 
страниц при максимизации полноты.
4. Сегментировать дефекты на изображениях дубликатов. Если будут обнаружены непересекающиеся дефекты - провести
замену на изображении лучшего качества, отобранное в п.1, сегментов с дефектами на сегменты из дубликатов, 
предварительно выровняв статистические параметры (среднюю яркость, дисперсию яркости) заменяющего сегмента с заменяемым.
Если сегменты дефектов пересекаются на дубликатах - ничего не делать.

## Функциональные требования

Программный комплекс должен:
1. работать автономно на рабочей станции.
2. сравнивать изображения отсканированных страниц, упорядоченных по порядку сканирования
и находить дубликаты страниц и титульные страницы выпусков газет/журналов.
3. Среди дубликатов страниц оставлять изображения лучшего качества (качество оценивать по степени размытости
изображений, распределению оттенков по гистограммам).
4. обнаруживать дефекты на изображениях, имеющих дубликаты (царапины, коробление бумаги, иные дефекты пленки) и 
восстанавливать поврежденные области аналогичными из дубликатов. При вставке областей изображения из дубликата
 проводить регистрацию изображений страниц перед изъятием  области для замены в дубликате, выравнивать статистические параметры области изображения с оригиналом.
5. группировать изображения по выпускам, опираясь на обнаруженные титульные листы (по логотипу и названию), которые являются разделителями 
выпусков в упорядоченном датасете изображений.
6. Сохранять результаты работы по папкам выпусков, удаленные дубликаты помещать внутри папок выпусков в папке дубликатов.
7. Сохранять восстановленные страницы из нескольких дубликатов в папку внутри папок выпусков, в отдельном файле json
сохранять сегментацию дефектов.
8. При наличии в данных поврежденных файлов, сохранять их в отдельную папку внутри папки выпуска.
9. Результаты работы (файлы в структуре папок) должны сохраняться в защищенном хранилище.
10. Иметь функцию авторизации пользователей для доступа к защищенному хранилищу, 
удалять все временные файлы по окончанию работы.
11. Иметь функцию логирования авторизации пользователей и выполненных ими работ в базе данных SQL (или локально в mySQL,
если допустимо хранение логов без ограничения доступа).

Структура папок выходных данных:  
|-"Название выпуска"_ID  
|--Дубликаты  
|--Восстановленные  
|--Поврежденные

Структура JSON файла разметки дефектов:  
{
"file": имя файла,
"type": тип дефекта,
"mask": пиксельная маска дефекта,
"d_file": - файл дубликата, из которого взят поврежденный фрагмент
}

## Нефункциональные требования

Будем опираться на рабочую станцию со следующими параметрами:
процессор AMD Ryzen3 1200, 16Гб ОЗУ, GPU RTX3060 12Гб.

Программный комплекс должен:
1. иметь скорость обработки изображений: < 60с на изображение (поиск дубликатов, поиск титульных страниц и восстановление дефектов на страницах, имеющих дубликаты).
2. иметь точность нахождения дубликатов страниц не хуже 90%, полнота - не хуже 0.8.
3. иметь точность определения титульных страниц не хуже 95%, полнота - не хуже 0.9.
4. иметь точность определения дефектов страниц: mAP > 0.35 (Высокая точность сегментации необязательна ввиду вставки на 
место дефекта аналогичной области из дубликата), полнота обнаружения дефектов - более 0.7. 

## Интерфейсы

Программный комплекс должен взаимодействовать с пользователем через графический локальный web интерфейс (на локальном ПК).
Web сервис должен иметь разделение на бэкенд сервер, реализующий программный интерфейс REST API для авторизации, выбора 
сета изображений для работы, считывания логов предыдущих работ, запуска и останова обработки данных, и пользовательский
графический интерфейс на базе шаблонизатора jinja и java скриптов, реализующий форму авторизации, форму задания параметров работы 
(выбор раздела хранилища для работы, выбор планируемого объема работ),
форму с индикацией прогресса выполнения работы и отображением промежуточных результатов в виде числа обработанных изображений,
числа кластеров с дубликатами, числа кластеров выпусков, форму просмотра логов работы пользователей, форму валидации результатов
работы алгоритма оператором (подтверждение выбора изображений из найденных кластеров дубликатов, подтверждение правильности
определения кластеров дубликатов, подтверждение найденных титульных листов). 
Асинхронность интерфейса обеспечить за счет периодических запросов состояния выполнения работы с помощью java.
В случае ошибки авторизации доступ к хранилищу не предоставляется. Пользователю должно сообщаться о неверном имени 
пользователя или пароля. 
В случае ошибки доступа к хранилищу с изображениями пользователь должен быть уведомлен об этом. Попытки автоматического
восстановления доступа должны быть ограничены 5 попытками. 
Такая реализация позволит масштабировать программный комплекс в сетевой сервис при необходимости.  
В случае нехватки памяти или иных сбоях при работе с данными пользователь должен быть уведомлен об этом. Работа должна быть прекращена.

## Данные

Все изображения после авторизации пользователя в программном комплексе извлекаются из защищенного хранилища.  
Форматы изображений на входе и выходе работы программного комплекса: PNG. Изображения могут быть как цветные, так и черно-белые.
Максимальное разрешение изображений определяется требование к аппаратному обеспечению рабочей станции и влияет на
время обработки. Нет точных данных о том, сколько памяти понадобится при обработке изображений и какое время будет
идти обработка на каком разрешении. Для определенности ограничим предельное разрешение изображений 2000х2000 пикселей.
В ходе работы это требование может быть скорректировано. Если изображения, получаемые из хранилища, будут иметь размер
больше предельного, нужно будет уменьшить размер изображений до начала обработки.
Изображения не содержат личное информации или других юридически чувствительных элементов. Поэтому нет ограничений по работе с ними.
Единственным ограничением является распространение или утечка самих изображений за пределы рабочей станции. Но эта проблема
решается заказчиком путем изолирования станции от сети интернет. Скачивание данных сотрудниками должно быть невозможно,
если станция работает с защищенным хранилищем в интранет сети. 

## Приемочные тесты

Программный комплекс тестируется на рабочей станции заказчика на изображениях страниц 50 выпусков газет, не менее 5 которых
содержат дубликаты. Ошибка ложного определения титульных страниц должна быть не более 10%, ошибка пропуска титульных страниц
должна быть не более 1%, ошибка ложного определения дубликатов страниц должна быть не более 10%, ошибка пропуска дубликатов - 
не более 5%.

## Открытые вопросы

На данный момент остаются вопросы, требующие ответа от заказчика, для дальнейшей работы:
1. Тип защищенного хранилища и возможность и необходимость его применения.
2. Тип авторизации пользователей, если есть такая необходимость.
3. Необходимость безопасного удаления файлов на локальной станции.
4. Формат и разрешение изображений страниц.
5. Требования к рабочей станции.