# Введение
Компьютерное зрение играет ключевую роль в обработке визуальной информации, позволяя автоматизировать процессы анализа изображений и распознавания объектов. Данная выпускная квалификационная работа посвящена разработке модели компьютерного зрения для обработки фотоснимков страниц периодических изданий с целью решения двух важных задач: исключение дубликатов страниц и группировку выпусков.

## Актуальность исследования
Обработка большого объема цифровых материалов становится актуальной задачей в эпоху цифровизации архивов и библиотек. Автоматическое выявление дублирующихся страниц позволяет оптимизировать хранение и управление информацией, предотвращая избыточность данных. Группировка выпусков помогает систематизировать архивы, облегчая последующий поиск и навигацию.

## Проблематика исследований
При решении поставленных задач возникают значительные трудности, обусловленные особенностями самих фотоснимков и спецификой структуры периодических изданий. Среди наиболее значимых проблем выделяются:

### Проблема низкого качества снимков
Многие сканированные страницы имеют низкое разрешение, недостаточную четкость, неравномерную яркость и оттенки серого цвета. Это усложняет процесс сопоставления изображений и идентификации дубликатов.

### Высокая схожесть стилей страниц
Страницы разных выпусков часто обладают похожими элементами дизайна, такими как шрифт, расположение заголовков и общий макет. Это создает дополнительные трудности при сравнении страниц и определении уникальных характеристик каждого выпуска.

### Сложности с идентификацией титулов и обложек
На первых страницах журналов и газет содержатся важные элементы, такие как логотип издания и номер выпуска. Однако обнаружить и сравнить эти элементы вручную крайне трудоемко. Необходимы автоматизированные инструменты для точного выделения и анализа данных элементов.

### Ограниченность ресурсов оборудования
Вычислительно интенсивные операции требуют значительных вычислительных мощностей. Поэтому важно учитывать ограничения по ресурсам и выбирать подходящие архитектуры моделей, способные эффективно справляться с большим объемом данных.

## Цель и задачи исследования
Целью работы является создание эффективной модели компьютерного зрения, способной качественно решать поставленные задачи. Для достижения цели необходимо решить следующие задачи:

- Исключение дубликатов: разработка метода, позволяющего выявлять и удалять повторяющиеся страницы, сохраняя только качественные экземпляры.
- Группировка выпусков: создание алгоритма, обеспечивающего точное разделение снимков страниц по соответствующим выпускам.
- Сегментация дефектов на изображениях при наличии дубликатов с последующей заменой поврежденных областей изображения неповрежденными частями из дубликатов.

# Описание проекта

## Функционал

В проекте на данный момент реализовано минимально функциональное приложение (MVP) с
интерфейсом командной строки. Функционал MVP ограничен поиском нечетких дубликатов изображений страниц,
упорядоченных порядку следования. MVP копирует файлы в выходную директорию, оставляя только изображения лучшего
качества среди дубликатов. Остальные дубликаты копируются в подпапку с названием "duplicates" в выходной директории и
группируются в папках с именами, совпадающими с именем 1 файла дубликата в серии.

## Установка

Проект требует Python версии 3.11 или выше и протестирован на операционной системе Windows 10.

### Шаги по установке

1. **Клонирование репозитория**
   
   Склонируйте репозиторий на локальный компьютер с помощью Git:
   ```
   git clone https://github.com/average81/VKR_RSL_case.git
   cd VKR_RSL_case
   ```

2. **Создание виртуального окружения**

   Для изоляции зависимостей рекомендуется создать виртуальное окружение:
   ```
   python -m venv venv
   ```

   Активация виртуального окружения:
   - На Windows:
     ```
     venv\Scripts\activate
     ```
   - На Linux/macOS:
     ```
     source venv/bin/activate
     ```

3. **Установка зависимостей**

   Установите все необходимые библиотеки из файла `requirements.txt`:
   ```
   pip install -r requirements.txt
   ```

   Убедитесь, что установка прошла успешно, проверив список установленных пакетов:
   ```
   pip list
   ```

4. **Проверка установки**

   После установки вы можете проверить корректность настройки, запустив скрипт с параметром помощи:
   ```
   python process_images_cli.py -h
   ```

   Это выведет справку по доступным параметрам командной строки.

## Запуск

Основной алгоритм расположен в файле 'process_images_cli.py'.
Запуск осуществляется командой: 
python process_images_cli.py

Алгоритму передаются параметры в командной строке и через файл настроек 'config.yml'.
Параметры командной строки описаны в таблице 1. 

Таблица 1 -Параметры командной строки.

| Параметр командной строки | Тип аргумента | Значение по-умолчанию | Описание                                                                                                                                                           |
|---------------------------|---------------|-----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| input_dir                 | str           |                       | Путь к директории с исходными изображениями. Является обязательным, в командной строке следует за опциональными параметрами. Ключевое слово "input_dir" не пишется |
| --output_dir              | str           |     "output"          | Путь к директории для сохранения результатов.                                                                                                                      |
| -v, --verbose             | -             |                       | Включает подробное логирование процесса выполнения в терминале.                                                                                                    |
| -m, --metrics             | -             |                       | Включает сохранение метрик схожести файлов изображений в файл "metrics.csv" в корневой папке проекта                                                               |
| --config_path             | str           |   "config.yml"        | Путь к файлу конфигурации в формате yaml.                                                                                                                          |
| -h                        | -             |                       | Вывод справки по параметрам командной строки.                                                                                                                      |

Пример вызова: python process_images_cli.py -v -m "prep_dataset/"

Параметры в файле настроек описаны в таблице 2. 

Таблица 2 - Параметры файла настроек

| Параметр            | Тип аргумента | Описание                                                                                                                                                                |
|---------------------|---------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| db_path             | str           | Путь к базе данных SQLite, в которой ведется запись обработанных файлов и результат обработки                                                                           |
| duplicate_threshold | float         | Значение порога степени схожести 2 файлов, выше которого файлы считать дубликатами. Должен быть в диапазоне [0;1]                                                       |
| match_threshold     | float         | Значение порога степени близости векторов признаков ключевых точек, больше которого считать, что признаки не похожи. Должен быть в диапазоне [0;1]                      |
| matcher             | str           | Название алгоритма сравнения векторов признаков. Возможен выбор из "BF" (Brute force) и "FLANN" (Fast Library for Approximate Nearest Neighbors)                        |
| feature_extractor   | str           | Название алгоритма извлечения признаков и поиска ключевых точек. Возможен выбор из "ORB" (Oriented FAST and Rotated BRIEF) и "SIFT" (Scale-Invariant Feature Transform) |

## Описание работы

При запуске программы происходит чтение параметров из файла настроек и командной строки.
Если директория с исходными изображениями указано верно, то программа создает список файлов изображений.
Предполагается, что изображения расположены в одной папке и имеют одинаковые имена и некоторое число в названии, 
которое упорядочивает их в порядке следования.  
Следующим шагом считывается таблица обработанных изображений из базы данных, если она есть.
Из списка файлов изображений отбираются те, которые не были обработаны ранее.  
В процессе работы у каждого изображения вычисляются вектора признаков и сравниваются с
векторами признаков предыдущего обработанного изображения. Если степень сходства высокая,
изображения помечаются, как дубликаты и сохраняются в отдельную папку. Как только фиксируется
изображение, которое не является дубликатом предыдущего, фиксируется группа дубликатов.
В группе дубликатов проводится анализ качества изображений нереференсным методом BRISQUE.
Из дубликатов выбирается изображение с наилучшим качеством и копируется в выходную директорию.

Результатом работы является набор обработанных изображений, записей в базе данных и файла метрик сходства.

Структура записей в базе данных представлена в таблице 3.  
Таблица 3 - Структура базы данных SQLite.  

| Параметр      | Тип     | Описание                                                                                |
|---------------|---------|-----------------------------------------------------------------------------------------|
| id            | INTEGER | Уникальный идентификатор записи                                                         |
| file_name     | TEXT    | Название файла изображения                                                              |
| timestamp     | TEXT    | Дата и время обработки                                                                  |
| user          | TEXT    | пользователь ОС, который запускал программу                                             |
| path          | TEXT    | Путь до файла в выходной папке                                                          |
| duplicates    | INTEGER | Номер дубликата в серии дубликатов                                                      |
| main_double   | TEXT    | Название первого файла в серии дубликатов                                               |
| enhanced_path | TEXT    | Путь до улучшенного изображения после замены дефектных сегментов (в MVP не реализовано) |

Ведение базы данных позволяет продолжить обработку с места остановки в случае сбоя или прерывания программы.

## Подготовка данных для тестирования

В папке `utils` проекта находится скрипт `dataset_prepare.py` для подготовки тестовых данных. Подробное описание алгоритма работы скрипта доступно в [документации](doc/dataset_prepare.md).


